name: deploy to kafka broker

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1   # ✅ 리전 고정 (한 곳에서 관리)

    steps:
    - name: checkout release
      uses: actions/checkout@v4
      # 한글: 레포 체크아웃

    - name: archive to tar.gz
      run: tar cvfz ./kafka-producer.tar.gz *
      # 한글: 배포 번들 생성

    - name: AWS configure credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
        aws-secret-access-key: ${{ secrets.AWS_ACCESS_SECRET_KEY }}
        aws-region: ${{ env.AWS_REGION }}
      # 한글: 자격증명+리전 설정

    - name: upload to S3
      run: aws s3 cp --region "$AWS_REGION" ./kafka-producer.tar.gz s3://datalake-actions-deploy-siw/kafka-producer/kafka-producer.tar.gz
      # 한글: S3 업로드 (리전 일치)

    - name: deploy with AWS CodeDeploy
      run: |
        aws deploy create-deployment \
          --region "$AWS_REGION" \
          --application-name datalake-deploy \
          --deployment-group-name kafka-deploy \
          --s3-location bucket=datalake-actions-deploy-siw,bundleType=tgz,key=kafka-producer/kafka-producer.tar.gz
      # 한글: CodeDeploy 배포 생성 (리전 일치)
