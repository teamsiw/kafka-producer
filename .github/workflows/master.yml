name: deploy to kafka broker

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      APP_NAME: datalake-deploy         # 주석: CodeDeploy 애플리케이션명
      GROUP_NAME: kafka-deploy          # 주석: 배포그룹명
      AWS_REGION: ap-northeast-2        # 주석: 리전 고정
      BKT: datalake-actions-deploy-siw  # 주석: S3 버킷
      KEY: kafka-producer/kafka-producer.tar.gz

    steps:
    - name: checkout
      uses: actions/checkout@v4

    - name: archive to tar.gz
      run: |
        # 주석: 필요 폴더만 압축 권장(예: src, app 등)
        tar cvfz kafka-producer.tar.gz --exclude .git --exclude .github *

    - name: configure aws credentials
      # 주석: Access Key 사용시 v4도 가능. OIDC전환 권장
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
        aws-secret-access-key: ${{ secrets.AWS_ACCESS_SECRET_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: sanity check (who am i / region)
      run: |
        aws sts get-caller-identity    # 주석: 계정 확인
        aws configure list             # 주석: 리전/프로파일 확인

    - name: upload to S3
      run: |
        aws s3 cp ./kafka-producer.tar.gz s3://$BKT/$KEY --region $AWS_REGION
        aws s3 ls s3://$BKT/$KEY --region $AWS_REGION  # 주석: 업로드 확인

    - name: pre-check codedeploy resources
      run: |
        # 주석: 애플리케이션/그룹 존재 확인(없으면 실패)
        aws deploy get-application --application-name "$APP_NAME" --region $AWS_REGION
        aws deploy get-deployment-group --application-name "$APP_NAME" --deployment-group-name "$GROUP_NAME" --region $AWS_REGION

    - name: deploy with AWS CodeDeploy
      run: |
        aws deploy create-deployment \
          --application-name "$APP_NAME" \
          --deployment-group-name "$GROUP_NAME" \
          --s3-location bucket=$BKT,bundleType=tgz,key=$KEY \
          --region $AWS_REGION
